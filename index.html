<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Easy ML Image Classifier</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.14.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
body{background:#0b1220;color:white;font-family:'Poppins',sans-serif;padding:20px;}
h2{margin-top:0;font-weight:600;}
input,button{padding:10px;margin-top:6px;border-radius:8px;border:none;font-size:15px;box-sizing:border-box;font-family:'Poppins',sans-serif;transition:0.3s;}
input.classNameInput{background:white;color:black;width:100%;text-align:left;font-weight:500;}
button,input[type=file]{outline:none;width:100%;}
button:hover,input[type=file]:hover{filter:brightness(1.1);box-shadow:0 0 12px currentColor;}
.card{padding:14px;border-radius:14px;margin-bottom:14px;}
.small{font-size:12px;opacity:.7;}
.row{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;}
.row>*{flex:1;}
.progressbg{background:#1e293b;height:14px;border-radius:10px;overflow:hidden;margin-top:8px;}
.progress{height:14px;width:0;background:#22c55e;transition:.2s;}
.barbg{background:#1e293b;border-radius:8px;overflow:hidden;margin-top:6px;}
.bar{height:18px;display:flex;align-items:center;justify-content:flex-end;padding-right:6px;font-size:12px;color:white;text-shadow:1px 1px 2px black;}
.classname{padding:6px;border-radius:6px;margin-bottom:6px;font-weight:600;text-align:left;}
.dropdown {position: relative; display:inline-block; width:100%;}
.dropbtn{background-color:#3b82f6;color:white;padding:10px;font-size:15px;border-radius:8px;border:none;width:100%;cursor:pointer;text-align:left;transition:0.3s;font-family:'Poppins',sans-serif;}
.dropbtn:hover{filter:brightness(1.1);box-shadow:0 0 12px currentColor;}
.dropdown-content{display:none;position:absolute;background-color:#020617;width:100%;z-index:1;border-radius:8px;overflow:hidden;font-family:'Poppins',sans-serif;}
.dropdown-content a{color:white;padding:10px;text-decoration:none;display:block;cursor:pointer;transition:0.3s;font-weight:500;}
.dropdown-content a:hover{filter:brightness(1.2);}
.dropdown.show .dropdown-content{display:block;}
</style>
</head>
<body>

<h2>ðŸ§  Easy Image Classifier</h2>
<input id="classInput" class="classNameInput" placeholder="Class name">
<button id="addBtn" style="background:#3b82f6; color:white">âž• Add Class</button>
<div id="classList"></div>
<button id="trainBtn" style="background:#3b82f6; color:white">ðŸš€ Train Model</button>
<div class="progressbg"><div id="prog" class="progress"></div></div>
<div id="status"></div>
<h3>Test Image</h3>
<input id="testInput" type="file" accept="image/*" style="background:#3b82f6; color:white">
<div id="results"></div>

<script>
let net, classifier;
let classes=[];

// Presets
const PRESETS=[
  {name:"Green", shades:["#1f4d2b","#236635","#2b7a3b"]},
  {name:"Blue", shades:["#1e40af","#1e3a8a","#1e3fbb"]},
  {name:"Orange", shades:["#9a4212","#b45309","#c76a0d"]},
  {name:"Red", shades:["#6a1010","#991b1b","#b91c1c"]},
  {name:"Purple", shades:["#3e0f5c","#6b21a8","#7e22ce"]}
];

document.getElementById("addBtn").onclick=()=>{addClass();};
document.getElementById("trainBtn").onclick=()=>{train();};
document.getElementById("testInput").onchange=(e)=>{testImage(e);};

// Close all dropdowns when clicking outside
window.onclick=(e)=>{
  if(!e.target.matches('.dropbtn')){
    document.querySelectorAll(".dropdown").forEach(d=>d.classList.remove("show"));
  }
};

function addClass(){ 
  const name=document.getElementById("classInput").value.trim();
  if(!name) return alert("Enter class name");
  classes.push({name,images:[],preset:0});
  document.getElementById("classInput").value="";
  render();
}

function deleteClass(i){classes.splice(i,1);render();}
function wipeImages(i){classes[i].images=[];render();}
function deleteLastImage(i){classes[i].images.pop();render();}
function setPreset(ci,pi){classes[ci].preset=parseInt(pi); render();}

function render(){
  const classList=document.getElementById("classList");
  classList.innerHTML="";
  classes.forEach((c,i)=>{
    const color=PRESETS[c.preset].shades[1];
    const card=document.createElement("div");
    card.className="card";
    card.style.background=color+"33";

    let dropdownOptions = PRESETS.map((p,pi)=>
      `<a style="background:${p.shades[1]}; color:white" onclick="setPreset(${i},${pi})">${p.name}</a>`
    ).join("");

    card.innerHTML=`
      <div class="classname" style="background:${color}; color:white">${c.name}</div>
      <div class="small">${c.images.length} / 50 images</div>
      <input type="file" accept="image/*" multiple style="background:${color}; color:white; width:100%">
      <div class="row">
        <button style="background:${color}; color:white">Delete Last</button>
        <button style="background:${color}; color:white">Wipe All</button>
        <button style="background:${color}; color:white">Delete Class</button>
      </div>
      <div class="row">
        <div class="dropdown">
          <button class="dropbtn" style="background:${color}">${PRESETS[c.preset].name}</button>
          <div class="dropdown-content">${dropdownOptions}</div>
        </div>
      </div>
    `;
    classList.appendChild(card);

    const fileInput=card.querySelector("input[type=file]");
    fileInput.onchange=(e)=>addImages(e,i);

    const btns=card.querySelectorAll("button");
    btns[0].onclick=()=>deleteLastImage(i);
    btns[1].onclick=()=>wipeImages(i);
    btns[2].onclick=()=>deleteClass(i);

    const dropbtn=card.querySelector(".dropbtn");
    const dropdown=card.querySelector(".dropdown");
    dropbtn.onclick=(e)=>{
      e.stopPropagation();
      dropdown.classList.toggle("show");
    };

    const options=card.querySelectorAll(".dropdown-content a");
    options.forEach((opt,pi)=>{
      opt.onclick=(e)=>{
        e.stopPropagation();
        setPreset(i,pi);
        dropbtn.textContent=PRESETS[pi].name;
        dropbtn.style.background=PRESETS[pi].shades[1];
        dropdown.classList.remove("show");
      };
    });
  });
}

function addImages(e,i){
  const maxImages = 50;
  const availableSlots = maxImages - classes[i].images.length;
  if(availableSlots <= 0) return alert("Maximum 50 images per class reached!");
  const filesToAdd = Array.from(e.target.files).slice(0, availableSlots);
  filesToAdd.forEach(f=>{
    const img=new Image();
    img.onload=()=>{
      // Resize to 224x224 to save memory
      const canvas=document.createElement("canvas");
      const ctx=canvas.getContext("2d");
      canvas.width=224;
      canvas.height=224;
      ctx.drawImage(img,0,0,224,224);
      const resizedImg=new Image();
      resizedImg.onload=()=>{
        classes[i].images.push(resizedImg);
        render();
      };
      resizedImg.src=canvas.toDataURL();
    };
    img.src=URL.createObjectURL(f);
  });
}

async function train(){
  if(classes.length<2) return alert("Need 2+ classes");
  if(classes.some(c=>c.images.length<5)) return alert("Each class needs 5+ images");
  document.getElementById("status").textContent="Loading model...";
  if(!net) net = await mobilenet.load();

  const xs=[], ys=[];
  classes.forEach((c,i)=>{
    c.images.forEach(img=>{
      tf.tidy(()=>{
        const t = tf.browser.fromPixels(img).resizeBilinear([224,224]).expandDims(0);
        xs.push(net.infer(t,true));
        ys.push(i);
      });
    });
  });

  const x = tf.concat(xs);
  const y = tf.tensor1d(ys, "int32");

  classifier = tf.sequential();
  classifier.add(tf.layers.dense({inputShape:[1024], units: classes.length, activation:"softmax"}));
  classifier.compile({optimizer: tf.train.adam(0.0003), loss: "sparseCategoricalCrossentropy"});

  const progBar = document.getElementById("prog");

  for(let i=0; i<20; i++){
    await classifier.fit(x, y, {epochs:1});
    progBar.style.width = ((i+1)/20*100) + "%";
    await new Promise(r => setTimeout(r, 10)); // allow browser to repaint
  }

  document.getElementById("status").textContent = "âœ… Training complete";
  x.dispose(); y.dispose(); xs.forEach(t => t.dispose());
}

function testImage(e){
  if(!classifier) return alert("Train first");
  const img=new Image();
  img.onload=()=>predict(img);
  img.src=URL.createObjectURL(e.target.files[0]);
}

function predict(img){
  const t=tf.browser.fromPixels(img).expandDims(0);
  const e=net.infer(t,true);
  const p=classifier.predict(e).dataSync();
  const results=document.getElementById("results");
  results.innerHTML="";
  p.forEach((v,i)=>{
    const pct=(v*100).toFixed(1);
    const color=PRESETS[classes[i].preset].shades[1];
    results.innerHTML+=`
      <div>${classes[i].name}</div>
      <div class="barbg">
        <div class="bar" style="width:${pct}%; background:${color};">
          ${pct}%
        </div>
      </div>`;
  });
  t.dispose(); e.dispose();
}

render();
</script>
</body>
</html>
