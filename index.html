<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Grade 7 ML Image Classifier</title>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.14.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>

<style>
:root{
  --bg:#0b1220;
  --panel:#020617;
  --accent:#3b82f6;
  --danger:#ef4444;
  --muted:#1e293b;
  --glow:0 0 14px rgba(59,130,246,.6);
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui;
  background:var(--bg);
  color:white;
}
header{
  padding:14px;
  text-align:center;
  font-size:22px;
  font-weight:600;
}
.main{
  display:grid;
  grid-template-columns:360px 1fr;
  gap:14px;
  padding:14px;
}
.panel{
  background:var(--panel);
  border-radius:16px;
  padding:14px;
  box-shadow:0 0 30px #000;
}
video{
  width:100%;
  border-radius:12px;
  box-shadow:var(--glow);
}
button{
  width:100%;
  padding:8px;
  margin-top:6px;
  border:none;
  border-radius:10px;
  background:var(--accent);
  color:white;
  cursor:pointer;
  transition:.2s;
}
button:hover{
  filter:brightness(1.15);
  box-shadow:var(--glow);
}
.danger{background:var(--danger)}
input{
  width:100%;
  padding:7px;
  margin-top:6px;
  border-radius:8px;
  border:none;
  background:var(--muted);
  color:white;
}
.progressbg{
  background:#1e293b;
  height:14px;
  border-radius:10px;
  overflow:hidden;
  margin-top:8px;
}
.progress{
  height:14px;
  width:0;
  background:linear-gradient(90deg,#3b82f6,#22c55e);
  transition:.3s;
}
.barbg{
  background:#1e293b;
  height:12px;
  border-radius:6px;
  margin:6px 0;
}
.bar{
  height:12px;
  width:0;
  background:#22c55e;
  border-radius:6px;
  transition:.2s;
}
</style>
</head>

<body>

<header>ðŸ¤– Grade 7 Machine Learning Image Classifier</header>

<div class="main">
  <div class="panel">
    <video id="video" autoplay playsinline></video>

    <input id="className" placeholder="Class name">
    <button onclick="addClass()">âž• Add Class</button>

    <input type="file" multiple accept="image/*" onchange="addImages(event)">

    <button onclick="train()">ðŸš€ Train Model</button>
    <button class="danger" onclick="stopTraining()">ðŸ›‘ Stop Training</button>
    <button onclick="startLive()">ðŸ“¹ Live Test</button>

    <input type="file" accept="image/*" onchange="testImage(event)">
  </div>

  <div class="panel">
    <h3>Training</h3>
    <div id="results"></div>

    <h3>Predictions</h3>
    <div id="bars"></div>
  </div>
</div>

<script>
let net,classifier,classes=[],currentClass=0
let live=false,lastPredict=0,stopFlag=false
const FPS=200

navigator.mediaDevices.getUserMedia({video:true})
.then(s=>video.srcObject=s)

function addClass(){
  const n=className.value.trim()
  if(!n) return alert("name needed")
  classes.push({name:n,images:[]})
  currentClass=classes.length-1
  className.value=""
  updateBars()
}

function addImages(e){
  if(!classes.length) return alert("add class first")
  for(const f of e.target.files){
    const img=new Image()
    img.onload=()=>classes[currentClass].images.push(img)
    img.src=URL.createObjectURL(f)
  }
}

function updateBars(){
  bars.innerHTML=""
  classes.forEach(c=>{
    bars.innerHTML+=`
      <div>${c.name}</div>
      <div class="barbg"><div class="bar"></div></div>`
  })
}

async function train(){
  stopFlag=false
  if(classes.some(c=>c.images.length<5))
    return alert("âŒ each class needs 5+ images")

  results.innerHTML=`
    <div class="progressbg"><div id="prog" class="progress"></div></div>
    <div id="time"></div>`

  if(!net) net=await mobilenet.load()

  const xs=[],ys=[]
  classes.forEach((c,i)=>{
    c.images.forEach(img=>{
      const t=tf.browser.fromPixels(img).expandDims(0)
      xs.push(net.infer(t,true))
      ys.push(i)
      t.dispose()
    })
  })

  const x=tf.concat(xs)
  const y=tf.tensor1d(ys,"int32")

  classifier=tf.sequential()
  classifier.add(tf.layers.dense({
    inputShape:[1024],
    units:classes.length,
    activation:"softmax"
  }))
  classifier.compile({
    optimizer:tf.train.adam(0.0003),
    loss:"sparseCategoricalCrossentropy"
  })

  const E=20
  for(let i=0;i<E;i++){
    if(stopFlag){results.innerHTML="ðŸ›‘ stopped";return}
    await classifier.fit(x,y,{epochs:1,shuffle:true})
    prog.style.width=((i+1)/E*100)+"%"
    time.textContent=`Epoch ${i+1}/${E}`
    await tf.nextFrame()
  }

  results.innerHTML="âœ… Training complete"
  x.dispose();y.dispose();xs.forEach(t=>t.dispose())
}

function stopTraining(){stopFlag=true}

function startLive(){
  if(!classifier) return alert("train first")
  live=true
  requestAnimationFrame(loop)
}

function loop(t){
  if(!live) return
  if(t-lastPredict>FPS){
    predict(video)
    lastPredict=t
  }
  requestAnimationFrame(loop)
}

function predict(src){
  const img=tf.browser.fromPixels(src).expandDims(0)
  const emb=net.infer(img,true)
  const p=classifier.predict(emb).dataSync()
  document.querySelectorAll(".bar")
    .forEach((b,i)=>b.style.width=(p[i]*100)+"%")
  img.dispose();emb.dispose()
}

function testImage(e){
  if(!classifier) return alert("train first")
  const img=new Image()
  img.onload=()=>predict(img)
  img.src=URL.createObjectURL(e.target.files[0])
}
</script>

</body>
</html>
