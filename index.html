<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ML Image Classifier</title>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>

<style>
body{
  margin:0;
  font-family:system-ui;
  background:#0b1220;
  color:white;
}

header{
  text-align:center;
  padding:16px;
  font-size:24px;
  font-weight:600;
}

.main{
  display:grid;
  grid-template-columns:360px 1fr;
  gap:16px;
  padding:16px;
}

.panel{
  background:#020617;
  border-radius:14px;
  padding:14px;
  box-shadow:0 0 20px #0008;
}

video{
  width:100%;
  border-radius:12px;
  margin-bottom:8px;
}

button{
  width:100%;
  padding:10px;
  margin-top:6px;
  border:none;
  border-radius:12px;
  background:#2563eb;
  color:white;
  cursor:pointer;
  transition:all .2s ease;
}

button:hover{
  filter:brightness(90%);
  box-shadow:0 0 12px #2563eb88;
  transform:translateY(-1px);
}

.small{
  background:#334155;
}
.small:hover{ box-shadow:0 0 10px #64748b88 }

.danger{
  background:#7f1d1d;
}
.danger:hover{ box-shadow:0 0 10px #ef444488 }

input{
  width:100%;
  padding:8px;
  border-radius:10px;
  border:none;
  margin-top:6px;
}

.card{
  background:#020617;
  border:1px solid #1e293b;
  border-radius:12px;
  padding:10px;
}

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:12px;
}

.count{
  font-size:12px;
  opacity:.7;
  margin-top:4px;
}

.barbg{
  background:#1e293b;
  border-radius:6px;
  overflow:hidden;
  margin-bottom:8px;
}

.bar{
  height:14px;
  width:0%;
  background:#22c55e;
  transition:width .2s ease;
}
</style>
</head>

<body>

<header>ğŸ¤– Grade 7 Machine Learning Image Classifier</header>

<div class="main">

  <!-- LEFT PANEL -->
  <div class="panel">
    <video id="video" autoplay playsinline></video>

    <button onclick="addClass()">â• Add Class</button>
    <button onclick="train()">ğŸš€ Train Model</button>
    <button onclick="startLive()">ğŸ“¹ Live Test</button>

    <input type="file" accept="image/*" onchange="testImage(event)">
  </div>

  <!-- RIGHT PANEL -->
  <div class="panel">
    <h3>Classes</h3>
    <div id="classes" class="grid"></div>

    <h3 id="topResult">Prediction: â€”</h3>
    <div id="results"></div>
  </div>

</div>

<script>
const MAX = 50
let classes = []
let net, classifier
let live=false
let lastPredict=0
const FPS=200

const video=document.getElementById("video")
const classesDiv=document.getElementById("classes")
const results=document.getElementById("results")
const topResult=document.getElementById("topResult")

// CAMERA
navigator.mediaDevices.getUserMedia({video:true})
.then(s=>video.srcObject=s)

// CLASS UI
function addClass(){
  classes.push({name:"", images:[]})
  render()
}

function render(){
  classesDiv.innerHTML=""
  classes.forEach((c,i)=>{
    classesDiv.innerHTML+=`
    <div class="card">
      <input value="${c.name}" placeholder="Class name"
        oninput="classes[${i}].name=this.value">
      <button onclick="capture(${i})">ğŸ“¸ Capture</button>
      <button onclick="document.getElementById('up${i}').click()">ğŸ“ Upload</button>
      <input id="up${i}" type="file" multiple accept="image/*" hidden
        onchange="upload(event,${i})">
      <button class="small" onclick="removeLast(${i})">â†© Delete Last</button>
      <button class="danger" onclick="wipe(${i})">ğŸ—‘ Wipe All</button>
      <button class="danger" onclick="deleteClass(${i})">âŒ Delete Class</button>
      <div class="count">${c.images.length}/${MAX}</div>
    </div>`
  })
}

function deleteClass(i){ classes.splice(i,1); render() }
function wipe(i){ classes[i].images=[]; render() }
function removeLast(i){ classes[i].images.pop(); render() }

// IMAGE INPUT
function capture(i){
  if(classes[i].images.length>=MAX) return
  const c=document.createElement("canvas")
  c.width=224;c.height=224
  c.getContext("2d").drawImage(video,0,0,224,224)
  classes[i].images.push(c)
  render()
}

function upload(e,i){
  for(const f of e.target.files){
    if(classes[i].images.length>=MAX) break
    const img=new Image()
    img.onload=()=>{
      const c=document.createElement("canvas")
      c.width=224;c.height=224
      c.getContext("2d").drawImage(img,0,0,224,224)
      classes[i].images.push(c)
      render()
    }
    img.src=URL.createObjectURL(f)
  }
}

// TRAIN
async function train(){
  if(!net) net=await mobilenet.load()
  const xs=[], ys=[]
  results.innerHTML="Training..."

  classes.forEach((c,i)=>{
    c.images.forEach(img=>{
      const t=tf.browser.fromPixels(img).expandDims(0)
      xs.push(net.infer(t,true))
      ys.push(i)
      t.dispose()
    })
  })

  if(xs.length===0){ alert("Add images"); return }

  const x=tf.concat(xs)
  const y=tf.tensor1d(ys,"int32")

  classifier=tf.sequential()
  classifier.add(tf.layers.dense({
    inputShape:[1024],
    units:classes.length,
    activation:"softmax"
  }))

  classifier.compile({
    optimizer:tf.train.adam(0.0003),
    loss:"sparseCategoricalCrossentropy",
    metrics:["accuracy"]
  })

  await classifier.fit(x,y,{
    epochs:20,
    callbacks:{
      onEpochEnd:(e,l)=>{
        results.innerHTML=`Epoch ${e+1}/20 â€” ${(l.acc*100).toFixed(1)}%`
      },
      onTrainEnd:()=>{
        results.innerHTML="âœ… Training complete"
        setupBars()
      }
    }
  })

  x.dispose(); y.dispose(); xs.forEach(t=>t.dispose())
}

// BARS
function setupBars(){
  results.innerHTML=""
  classes.forEach((c,i)=>{
    results.innerHTML+=`
      <div>${c.name||"Class "+(i+1)}</div>
      <div class="barbg"><div id="bar${i}" class="bar"></div></div>`
  })
}

// LIVE
function startLive(){
  if(!classifier){ alert("Train first"); return }
  live=true
  requestAnimationFrame(loop)
}

function loop(t){
  if(!live) return
  if(t-lastPredict>FPS){
    predict(video)
    lastPredict=t
  }
  requestAnimationFrame(loop)
}

// IMAGE TEST
function testImage(e){
  if(!classifier){ alert("Train first"); return }
  const img=new Image()
  img.onload=()=>predict(img)
  img.src=URL.createObjectURL(e.target.files[0])
}

// PREDICT
function predict(src){
  const c=document.createElement("canvas")
  c.width=224;c.height=224
  c.getContext("2d").drawImage(src,0,0,224,224)

  const t=tf.browser.fromPixels(c).expandDims(0)
  const p=classifier.predict(net.infer(t,true)).dataSync()

  let best=0
  p.forEach((v,i)=>{
    document.getElementById("bar"+i).style.width=(v*100)+"%"
    if(v>p[best]) best=i
  })

  topResult.textContent="Prediction: "+(classes[best].name||"Class "+(best+1))
  t.dispose()
}

// INITIAL CLASSES (IMPORTANT)
addClass()
addClass()
</script>
</body>
</html>
