<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Grade 7 ML Science Fair</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.18.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>

<style>
body{margin:0;font-family:Arial;background:#0f0f0f;color:white}
#sidebar{position:fixed;left:0;top:0;width:280px;height:100vh;background:#1a1a1a;padding:20px;border-right:2px solid #333;overflow-y:auto}
#main{margin-left:310px;padding:20px}
.btn{width:100%;padding:10px;margin-top:6px;border:none;border-radius:6px;background:#3a3a3a;color:white;cursor:pointer}
.btn:hover{background:#555}
.class-box{background:#222;border:1px solid #555;padding:10px;border-radius:6px;margin-top:10px}
.small{font-size:13px;color:#ccc}
video,img{width:340px;height:260px;border-radius:8px;background:black;object-fit:cover}
.bar-bg{width:100%;height:20px;background:#333;border-radius:6px}
.bar-fill{height:100%;width:0%;border-radius:6px;transition:.2s}
.green{background:#00d26a}
.yellow{background:#f5c542}
.red{background:#ff4d4d}
</style>
</head>

<body>
<div id="sidebar">
<h2>ðŸ“¦ Classes</h2>
<button class="btn" onclick="addClass()">Add Class</button>
<div id="classList"></div>

<h2 style="margin-top:20px">ðŸ§ª Mode</h2>
<button class="btn" onclick="setMode('live')">Live Camera</button>
<button class="btn" onclick="setMode('image')">Image Test</button>

<h2 style="margin-top:20px">ðŸš€ Train</h2>
<button class="btn" onclick="trainModel()">Train Model</button>
<p id="trainStatus" class="small"></p>

<input type="file" accept="image/*" class="btn" onchange="predictImage(this)">
</div>

<div id="main">
<h1>Machine Learning Image Classifier</h1>

<video id="video" autoplay playsinline></video>
<img id="imgTest" style="display:none">

<h2>Predictions</h2>
<div id="predictionArea"></div>

<h3 id="accuracy">Accuracy: --%</h3>
</div>

<script>
let classes=[], net, model, stream=null, mode="none"

function addClass(){
 const id=classes.length
 const box=document.createElement("div")
 box.className="class-box"
 box.innerHTML=`
 <input id="name${id}" class="btn" placeholder="Class name">
 <input type="file" multiple accept="image/*" class="btn" onchange="addImages(${id},this)">
 <p id="count${id}" class="small">Images: 0</p>`
 document.getElementById("classList").appendChild(box)
 classes.push({images:[],name:""})
}

function addImages(id,input){
 for(const f of input.files){
  const img=new Image()
  img.src=URL.createObjectURL(f)
  classes[id].images.push(img)
 }
 document.getElementById("count"+id).textContent="Images: "+classes[id].images.length
}

async function setMode(m){
 mode=m
 if(m==="live"){
  document.getElementById("imgTest").style.display="none"
  document.getElementById("video").style.display="block"
  stream=await navigator.mediaDevices.getUserMedia({video:true})
  video.srcObject=stream
  loop()
 }else{
  if(stream)stream.getTracks().forEach(t=>t.stop())
  video.style.display="none"
 }
}

async function trainModel(){
 if(classes.length<2){alert("Need 2 classes");return}
 document.getElementById("trainStatus").textContent="Loading MobileNet..."
 net=await mobilenet.load()

 let xs=[], ys=[]
 for(let i=0;i<classes.length;i++){
  classes[i].name=document.getElementById("name"+i).value||"Class "+i
  for(const img of classes[i].images){
   const t=tf.browser.fromPixels(img).resizeNearestNeighbor([224,224]).toFloat().div(255).expandDims()
   xs.push(net.infer(t,"conv_preds"))
   ys.push(i)
   t.dispose()
  }
 }

 const X=tf.concat(xs)
 const Y=tf.tensor1d(ys,"int32")

 model=tf.sequential()
 model.add(tf.layers.dense({inputShape:[1024],units:classes.length,activation:"softmax"}))
 model.compile({optimizer:"adam",loss:"sparseCategoricalCrossentropy",metrics:["accuracy"]})

 await model.fit(X,Y,{epochs:10,callbacks:{
  onEpochEnd:(e,l)=>{
   document.getElementById("accuracy").textContent="Accuracy: "+(l.acc*100).toFixed(1)+"%"
  }
 }})

 xs.forEach(t=>t.dispose())
 X.dispose();Y.dispose()

 setupBars()
 document.getElementById("trainStatus").textContent="Training complete"
}

function setupBars(){
 const area=document.getElementById("predictionArea")
 area.innerHTML=""
 classes.forEach((c,i)=>{
  area.innerHTML+=`
  <strong>${c.name}</strong>
  <div class="bar-bg"><div id="bar${i}" class="bar-fill"></div></div>
  <p id="pct${i}" class="small"></p>`
 })
}

async function predict(t){
 const e=net.infer(t,"conv_preds")
 const p=model.predict(e)
 const data=await p.data()

 data.forEach((v,i)=>{
  const percent=(v*100).toFixed(1)
  const bar=document.getElementById("bar"+i)
  bar.style.width=percent+"%"
  bar.className="bar-fill "+(percent>70?"green":percent>40?"yellow":"red")
  document.getElementById("pct"+i).textContent=percent+"%"
 })

 t.dispose();e.dispose();p.dispose()
}

async function loop(){
 if(!model||mode!=="live")return
 const t=tf.browser.fromPixels(video).resizeNearestNeighbor([224,224]).toFloat().div(255).expandDims()
 await predict(t)
 requestAnimationFrame(loop)
}

async function predictImage(input){
 if(!model)return
 const img=document.getElementById("imgTest")
 img.src=URL.createObjectURL(input.files[0])
 img.style.display="block"
 await img.decode()
 const t=tf.browser.fromPixels(img).resizeNearestNeighbor([224,224]).toFloat().div(255).expandDims()
 predict(t)
}
</script>
</body>
</html>
