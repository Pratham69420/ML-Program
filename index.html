<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Custom Teachable Machine Optimized</title>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.18.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
<style>
body{margin:0;font-family:Arial;background:#111;color:white;}
#sidebar{position:fixed;left:0;top:0;width:280px;height:100vh;background:#1a1a1a;padding:20px;overflow-y:auto;border-right:2px solid #333;}
#main{margin-left:310px;padding:20px;}
.btn{width:100%;padding:10px;margin-top:6px;border:none;border-radius:6px;background:#3a3a3a;color:white;cursor:pointer;}
.btn:hover{background:#555;}
.class-box{background:#222;border:1px solid #555;padding:12px;border-radius:6px;margin-top:10px;}
.upload-btn{background:#444;border-radius:10px;padding:8px 12px;color:white;cursor:pointer;margin-top:6px;font-size:14px;width:48%;margin-right:2%;}
#videoPreview{width:340px;height:260px;border-radius:8px;background:black;}
.predictionBar{height:22px;background:#444;border-radius:5px;margin-top:6px;width:90%;position:relative;}
.predictionFill{height:100%;background:#4caf50;border-radius:5px;}
.predictionLabel{font-size:14px;margin-top:4px;}
</style>
</head>
<body>
<div id="sidebar">
<h2>ðŸ“¦ Classes</h2>
<button class="btn" onclick="addClass()">âž• Add Class</button>
<button class="btn" onclick="clearAllClasses()">ðŸ—‘ Remove All Classes</button>
<div id="classList"></div>

<h2 style="margin-top:25px;">ðŸ“· Camera</h2>
<button class="btn" onclick="setDeviceMode('phone')">ðŸ“± Phone Mode</button>
<button class="btn" onclick="setDeviceMode('computer')">ðŸ’» Computer Mode</button>
<select id="cameraSelect" class="btn" onchange="switchCamera()"></select>

<h2 style="margin-top:20px;">ðŸ’¾ Model</h2>
<button class="btn" onclick="exportModel()">ðŸ’¾ Export Model</button>
<button class="btn" onclick="importModel()">ðŸ“‚ Import Model</button>
</div>

<div id="main">
<h1>Custom Teachable Machine Optimized</h1>
<video id="videoPreview" autoplay playsinline></video>
<canvas id="previewCanvas" style="display:none;"></canvas>

<h2>Live Predictions</h2>
<div id="predictionArea"></div>

<h2>Training</h2>
<button class="btn" onclick="trainModel()">ðŸš€ Train Model</button>
<div id="trainProgress" style="margin-top:10px;"></div>
</div>

<script>
let classes=[]; 
let deviceMode="computer"; 
let net; 
let webcamStream; 
let currentCameraId=null; 
let model; 
let EMBEDDINGS=[]; 
let LABELS=[];

// ---------- CAMERA ----------
async function setDeviceMode(mode){deviceMode=mode;loadCameras();}
async function loadCameras(){
    const devices=await navigator.mediaDevices.enumerateDevices();
    const cams=devices.filter(d=>d.kind==="videoinput");
    const sel=document.getElementById("cameraSelect");
    sel.innerHTML="";
    cams.forEach(cam=>{const option=document.createElement("option");option.value=cam.deviceId;option.textContent=cam.label||"Camera";sel.appendChild(option);});
    if(cams.length>0){currentCameraId=cams[0].deviceId;startCamera();}
}
async function startCamera(){
    if(webcamStream){webcamStream.getTracks().forEach(t=>t.stop());}
    let constraints=deviceMode==="phone"?{video:{deviceId:currentCameraId?{exact:currentCameraId}:undefined,facingMode:{ideal:"environment"}}}:{video:{deviceId:currentCameraId?{exact:currentCameraId}:undefined}};
    webcamStream=await navigator.mediaDevices.getUserMedia(constraints);
    document.getElementById("videoPreview").srcObject=webcamStream;
}
function switchCamera(){currentCameraId=document.getElementById("cameraSelect").value;startCamera();}

// ---------- CLASSES ----------
function addClass(){
    const classId=classes.length;
    let box=document.createElement("div");
    box.className="class-box";box.id="class-"+classId;
    box.innerHTML=`
<label>Class Name:</label>
<input id="name-${classId}" style="width:100%;padding:6px;margin-top:6px;background:#111;color:white;border:1px solid #555;" placeholder="e.g. Stop Sign">
<label style="margin-top:6px;display:block;">Emoji (optional):</label>
<input id="emoji-${classId}" style="width:100%;padding:6px;background:#111;color:white;border:1px solid #555;" placeholder="ðŸš—">
<div style="margin-top:6px;">
<button class="upload-btn" onclick="addExample(${classId})">ðŸ“‚ Upload Photos</button>
<button class="upload-btn" onclick="addExampleFromCamera(${classId})">ðŸ“· Capture Photo</button>
</div>
<button class="btn" onclick="removeTrainingImages(${classId})">ðŸ—‘ Remove Photos</button>
<p id="count-${classId}" style="margin-top:6px;">Images: 0</p>`;
    document.getElementById("classList").appendChild(box);
    classes.push({name:"",emoji:"",images:[],count:0});
}
function clearAllClasses(){classes=[];document.getElementById("classList").innerHTML="";document.getElementById("predictionArea").innerHTML="";}
function removeTrainingImages(id){classes[id].images=[];classes[id].count=0;document.getElementById("count-"+id).textContent="Images: 0";}

// ---------- UPLOAD / CAMERA ----------
async function addExample(classId){
    const input=document.createElement("input");
    input.type="file";input.accept="image/*";input.multiple=true;
    input.onchange=async ()=>{const files=[...input.files];for(const file of files){
        const url=URL.createObjectURL(file);
        const img=new Image();img.src=url;
        await new Promise(r=>img.onload=r);
        classes[classId].images.push(img);classes[classId].count++;
        document.getElementById("count-"+classId).textContent="Images: "+classes[classId].count;
        await tf.nextFrame(); // prevent freezing
    }};input.click();
}
function addExampleFromCamera(classId){
    const video=document.getElementById("videoPreview");
    const canvas=document.createElement("canvas");
    canvas.width=224;canvas.height=224; // reduce size
    const ctx=canvas.getContext("2d");ctx.drawImage(video,0,0,canvas.width,canvas.height);
    const img=new Image();img.src=canvas.toDataURL("image/png");
    classes[classId].images.push(img);classes[classId].count++;
    document.getElementById("count-"+classId).textContent="Images: "+classes[classId].count;
}

// ---------- TRAIN ----------
async function trainModel(){
    if(classes.length===0){alert("Add at least 1 class!");return;}
    document.getElementById("trainProgress").innerHTML="Loading MobileNet...";
    net=await mobilenet.load();
    EMBEDDINGS=[];LABELS=[];
    document.getElementById("trainProgress").innerHTML="Processing images...";
    for(let i=0;i<classes.length;i++){
        const nameBox=document.getElementById("name-"+i);
        const emojiBox=document.getElementById("emoji-"+i);
        classes[i].name=nameBox.value||("Class "+i);classes[i].emoji=emojiBox.value||"";
        for(let img of classes[i].images){
            const tensor=tf.browser.fromPixels(img).resizeNearestNeighbor([224,224]).toFloat().expandDims(0);
            const embedding=net.infer(tensor,"conv_preds");
            EMBEDDINGS.push(embedding);LABELS.push(i);
            tensor.dispose();await tf.nextFrame();
        }
        document.getElementById("trainProgress").innerHTML=`Processing Class ${i+1}/${classes.length}`;
    }
    if(EMBEDDINGS.length===0){alert("Add some images first!");return;}
    const xs=tf.concat(EMBEDDINGS);const ys=tf.tensor1d(LABELS,"int32");
    model=tf.sequential();
    model.add(tf.layers.dense({units:classes.length,activation:"softmax",inputShape:[1024]}));
    model.compile({optimizer:tf.train.adam(0.0005),loss:"sparseCategoricalCrossentropy",metrics:["accuracy"]});
    document.getElementById("trainProgress").innerHTML="Training...";
    await model.fit(xs,ys,{epochs:15,callbacks:{onEpochEnd:(e,l)=>document.getElementById("trainProgress").innerHTML=`Epoch ${e+1}/15 â€” Accuracy: ${(l.acc*100).toFixed(1)}%`}});
    xs.dispose();ys.dispose();
    EMBEDDINGS.forEach(t=>t.dispose());
    document.getElementById("trainProgress").innerHTML="âœ… Training Complete!";
    startPredictionLoop();
}

// ---------- PREDICTION ----------
async function startPredictionLoop(){
    const video=document.getElementById("videoPreview");
    document.getElementById("predictionArea").innerHTML="";
    for(let i=0;i<classes.length;i++){
        const row=document.createElement("div");row.style.margin="10px 0";
        row.innerHTML=`<strong>${classes[i].emoji} ${classes[i].name}</strong>
        <div id="bar-${i}" style="width:0%;height:20px;background:#00d26a;margin-top:4px;transition:width 0.2s;"></div>
        <span id="percent-${i}" style="color:#ccc;font-size:14px;"></span>`;
        document.getElementById("predictionArea").appendChild(row);
    }
    async function loop(){
        if(!model)return;
        const tensor=tf.browser.fromPixels(video).resizeNearestNeighbor([224,224]).toFloat().expandDims(0);
        const embedding=net.infer(tensor,"conv_preds");
        const prediction=model.predict(embedding);
        const probs=await prediction.data();
        for(let i=0;i<probs.length;i++){
            const p=(probs[i]*100).toFixed(1)+"%";
            document.getElementById("bar-"+i).style.width=p;
            document.getElementById("percent-"+i).textContent=p;
        }
        tensor.dispose();embedding.dispose();prediction.dispose();
        requestAnimationFrame(loop);
    }
    loop();
}

// ---------- EXPORT / IMPORT ----------
async function exportModel(){if(!model){alert("Train model first!");return;}await model.save("downloads://my-ml-model");alert("Model exported!");}
async function importModel(){const input=document.createElement("input");input.type="file";input.accept=".json";input.onchange=async e=>{const file=e.target.files[0];const url=URL.createObjectURL(file);model=await tf.loadLayersModel(url);alert("Model loaded!");};input.click();}

// Initialize
loadCameras();
</script>
</body>
</html>
