<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ML Classifier Pro</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0"></script>

<style>
/* ---------- GLOBAL ---------- */
body {
  margin: 0;
  background: #111;
  color: white;
  font-family: Arial, sans-serif;
  overflow-x: hidden;
}

/* ---------- LAYOUT ---------- */
.container {
  display: flex;
  flex-direction: row;
  height: 100vh;
}

.sidebar {
  width: 270px;
  background: #1c1c1c;
  padding: 20px;
  overflow-y: auto;
}

.main {
  flex: 1;
  display: flex;
  flex-direction: column;
  padding: 10px;
  align-items: center;
}

/* ---------- CAMERA AREA ---------- */
#video {
  border-radius: 10px;
  background: black;
}

/*** BIGGER ON COMPUTER ***/
.desktop #video {
  width: 60vw;
  height: auto;
}

/*** SMALLER BUT CLEAN ON PHONE ***/
.phone #video {
  width: 95vw;
  height: auto;
}

/* ---------- BUTTONS ---------- */
button {
  background: #333;
  color: white;
  padding: 10px 14px;
  margin: 4px;
  border: none;
  border-radius: 8px;
  font-size: 15px;
}
button:hover {
  background: #444;
}

/* ---------- CLASS LIST ---------- */
.classBox {
  background: #222;
  padding: 12px;
  border-radius: 10px;
  margin-bottom: 8px;
}
</style>
</head>

<body>

<div class="container">
  <!-- SIDEBAR -->
  <div class="sidebar">
    <h2>Classes</h2>
    <div id="classList"></div>

    <button onclick="addClass()">‚ûï Add Class</button>
    <button onclick="switchMode()">üîÑ Switch Device Mode</button>
    <hr>

    <button onclick="loadTMModel()">üì• Load TM Model</button>
  </div>

  <!-- MAIN AREA -->
  <div class="main">
    <h1>ML Classifier Pro</h1>

    <video id="video" autoplay playsinline></video>

    <div>
      <button onclick="capture()">üì∏ Capture</button>
      <button onclick="startPredict()">‚ñ∂ Live Predict</button>
    </div>

    <h2 id="predictionLabel">Prediction: ‚Äî</h2>
  </div>
</div>

<script>
/* ======================================================
   DEVICE MODE
======================================================*/
let deviceMode = ""; // "phone" or "desktop"

function autoDetectDevice() {
  if (window.innerWidth < 700) deviceMode = "phone";
  else deviceMode = "desktop";
  applyDeviceClass();
}

function switchMode() {
  deviceMode = (deviceMode === "phone") ? "desktop" : "phone";
  applyDeviceClass();
}

function applyDeviceClass() {
  document.body.classList.remove("phone", "desktop");
  document.body.classList.add(deviceMode);
}

/* ======================================================
   CAMERA SETUP
======================================================*/
async function startCamera() {
  let constraints;

  if (deviceMode === "phone") {
    constraints = { video: { facingMode: "environment" } };
  } else {
    constraints = { video: true };
  }

  const stream = await navigator.mediaDevices.getUserMedia(constraints);
  document.getElementById("video").srcObject = stream;
}

/* ======================================================
   CLASS SYSTEM
======================================================*/
let classes = [];

function addClass() {
  const name = prompt("Enter class name:");
  if (!name) return;

  const emoji = prompt("Enter emoji (optional):");

  classes.push({ name, emoji, images: [] });
  renderClassList();
}

function renderClassList() {
  const list = document.getElementById("classList");
  list.innerHTML = "";

  classes.forEach((cls, i) => {
    const div = document.createElement("div");
    div.className = "classBox";

    div.innerHTML = `
      <strong>${cls.emoji || ""} ${cls.name}</strong><br>
      Photos: ${cls.images.length}<br><br>
      <button onclick="clearClass(${i})">üóë Clear Photos</button>
      <button onclick="deleteClass(${i})">‚ùå Delete Class</button>
      <button onclick="setCurrentClass(${i})">üéØ Select</button>
    `;
    list.appendChild(div);
  });
}

let currentClass = -1;

function setCurrentClass(i) {
  currentClass = i;
  alert("Selected class: " + classes[i].name);
}

function clearClass(i) {
  classes[i].images = [];
  renderClassList();
}

function deleteClass(i) {
  classes.splice(i, 1);
  renderClassList();
}

/* ======================================================
   CAPTURE IMAGE
======================================================*/
function capture() {
  if (currentClass < 0) {
    alert("Select a class first!");
    return;
  }

  const video = document.getElementById("video");
  const canvas = document.createElement("canvas");

  canvas.width = 224;
  canvas.height = 224;

  const ctx = canvas.getContext("2d");
  ctx.drawImage(video, 0, 0, 224, 224);

  classes[currentClass].images.push(canvas.toDataURL());
  renderClassList();
}

/* ======================================================
   LOAD TEACHABLE MACHINE MODEL
======================================================*/
let tmModel;

async function loadTMModel() {
  const url = prompt("Paste Teachable Machine model URL:");
  if (!url) return;

  tmModel = await tf.loadLayersModel(url + "model.json");
  alert("Model loaded!");
}

/* ======================================================
   LIVE PREDICTION
======================================================*/
async function startPredict() {
  if (!tmModel) {
    alert("Load model first!");
    return;
  }

  const video = document.getElementById("video");

  async function step() {
    const t = tf.browser.fromPixels(video)
      .resizeBilinear([224, 224])
      .div(255)
      .expandDims();

    const p = await tmModel.predict(t).data();
    t.dispose();

    const maxIndex = p.indexOf(Math.max(...p));
    const percent = (p[maxIndex] * 100).toFixed(1);

    const label = classes[maxIndex]
      ? (classes[maxIndex].emoji || "") + " " + classes[maxIndex].name
      : "Unknown";

    document.getElementById("predictionLabel").innerText =
      `Prediction: ${label} (${percent}%)`;

    requestAnimationFrame(step);
  }
  step();
}

/* ======================================================
   INIT
======================================================*/
autoDetectDevice();
startCamera();
</script>
</body>
</html>
